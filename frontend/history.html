<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ClipVault | Clipboard History</title>
    <link rel="stylesheet" href="style_history.css">
</head>
<body>
    <div class="header">
        <div class="header-content">
            <a href="main.html" class="back-arrow">&lt;</a>
            <p>Clipboard History</p>
        </div>
    </div>

    <div class="main">
        <div class="entry-section-title">
            <h2>Entry</h2>
            <h2>Last Modified</h2>
            <div></div>
        </div>

        <div class="entries" id="entries-container">
        </div>
        <button class="clear-history-btn">Clear All History</button>
    </div>

    <script>
        // Check authentication on page load
        window.addEventListener('DOMContentLoaded', () => {
            if (!window.backend.auth.isLoggedIn()) {
                window.location.href = 'login.html';
                return;
            }
            
            loadHistory();
            
            document.querySelector(".clear-history-btn").addEventListener("click", () => {
                clearHistory();
            });

        });

        async function checkHealth() {
            try {
                const data = await window.backend.testConnection();
                return data.status === "ok";
            } catch (err) {
                console.error("Backend health check failed:", err);
                return false;
            }
        }

        function formatDate(isoString) {
            if (!isoString) return "Unknown";
            const date = new Date(isoString);
            return date.toLocaleString(undefined, {
                //year: "numeric",  // omit year for brevity
                month: "short",
                day: "2-digit",
                hour: "2-digit",
                minute: "2-digit",
                second: "2-digit",
                hour12: true
            });
        }

        async function loadHistory() {
            const healthy = await checkHealth();
            if (!healthy) {
                alert("Backend unavailable. Please ensure the server is running.");
                return;
            }

            try {
                const response = await window.backend.getHistory(20);
                // The backend now returns {history: [...], user: "username"}
                const history = response.history || response; // Handle both formats
                const container = document.getElementById("entries-container");
                container.innerHTML = "";

                if (!history || history.length === 0) {
                    // Check if there are encrypted entries that cannot be decrypted (key rotation scenario)
                    try {
                        const raw = await window.backend.rawHistory(5);
                        const count = (raw && raw.raw_history && raw.raw_history.length) ? raw.raw_history.length : 0;
                        if (count > 0) {
                            container.innerHTML = '<p style="text-align: center; color: #666; margin: 20px;">No decryptable history found. There are ' + count + ' encrypted items that cannot be decrypted (likely due to key rotation). You can add new entries or clear all history.</p>';
                        } else {
                            container.innerHTML = '<p style="text-align: center; color: #666; margin: 20px;">No clipboard history found.</p>';
                        }
                        return;
                    } catch {
                        container.innerHTML = '<p style="text-align: center; color: #666; margin: 20px;">No clipboard history found.</p>';
                        return;
                    }
                }

                history.forEach((entry, idx) => {
                    const row = document.createElement("div");
                    row.className = "entry-row";
                                
                    const btn = document.createElement("button");
                    btn.className = "entry-btn";
                    btn.dataset.enabled = "false";
                    btn.dataset.id = idx;
                    btn.textContent = "Click to reveal";
                                
                    const time = document.createElement("p");
                    time.className = "entry-modified-time";
                    time.textContent = formatDate(entry.timestamp) || "Unknown";
                                
                    const deleteBtn = document.createElement("button");
                    deleteBtn.className = "delete-btn";
                                
                    const deleteIcon = document.createElement("img");
                    deleteIcon.src = "./bin.png"; 
                    deleteIcon.alt = "Delete";
                                
                    deleteBtn.appendChild(deleteIcon);
                                
                    deleteBtn.addEventListener("click", async () => {
                        if (!confirm("Delete this entry?")) return;
                        try {
                            await window.backend.deleteHistoryEntry(entry.id);
                            row.remove();
                        } catch (e) {
                            console.error("Failed to delete entry", entry.id, e);
                            alert("Failed to delete entry. Please try again.");
                        }
                    });
                
                    btn.addEventListener("click", () => {
                        if (btn.dataset.enabled === "false") {
                            btn.dataset.enabled = "true";
                            btn.textContent = entry.content || "[Empty]";
                        } else {
                            btn.dataset.enabled = "false";
                            btn.textContent = "Click to reveal";
                        }
                    });
                
                    row.appendChild(btn);
                    row.appendChild(time);
                    row.appendChild(deleteBtn);
                    container.appendChild(row);
                });

            } catch (err) {
                console.error("Error loading history:", err);
            }
        }

        async function clearHistory() {
            if (!confirm("Are you sure you want to clear all clipboard history? This action cannot be undone.")) {
                return;
            }

            const healthy = await checkHealth();
            if (!healthy) {
                alert("Backend unavailable. Please ensure the server is running.");
                return;
            }

            try {
                await window.backend.clearHistory();
                document.getElementById("entries-container").innerHTML = '<p style="text-align: center; color: #28a745; margin: 20px;">âœ… History cleared successfully!</p>';
                
                // Reload history after a short delay
                setTimeout(() => {
                    loadHistory();
                }, 2000);
            } catch (err) {
                console.error("Error clearing history:", err);
                alert("Failed to clear history. Please try again.");
            }
        }
    </script>
</body>
</html>