<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ClipVault | Clipboard History</title>
    <link rel="stylesheet" href="style_history.css">
</head>
<body>
    <div class="header">
        <div class="header-content">
            <a href="main.html" class="back-arrow">&lt;</a>
            <p>Clipboard History</p>
        </div>
    </div>

    <div class="main">
        <div class="entry-section-title">
            <h2>Entry</h2>
            <h2>Last Modified</h2>
            <div></div>
        </div>

        <div class="entries" id="entries-container">
        </div>
        <button class="clear-history-btn">Clear All History</button>
    </div>

    <script>
        const BACKEND_URL = "http://127.0.0.1:8000";

        async function checkHealth() {
            try {
                const res = await fetch(`${BACKEND_URL}/health`);
                const data = await res.json();
                return data.status === "ok";
            } catch (err) {
                console.error("Backend health check failed:", err);
                return false;
            }
        }

        function formatDate(isoString) {
            if (!isoString) return "Unknown";
            const date = new Date(isoString);
            return date.toLocaleString(undefined, {
                //year: "numeric",  // omit year for brevity
                month: "short",
                day: "2-digit",
                hour: "2-digit",
                minute: "2-digit",
                second: "2-digit",
                hour12: true
            });
        }

        async function loadHistory() {
            const healthy = await checkHealth();
            if (!healthy) {
                alert("Backend unavailable. Please ensure the server is running.");
                return;
            }

            try {
                const res = await fetch(`${BACKEND_URL}/clipboard/history?limit=20`);
                const history = await res.json();
                const container = document.getElementById("entries-container");
                container.innerHTML = "";

                history.forEach((entry, idx) => {
                    const row = document.createElement("div");
                    row.className = "entry-row";
                                
                    const btn = document.createElement("button");
                    btn.className = "entry-btn";
                    btn.dataset.enabled = "false";
                    btn.dataset.id = idx;
                    btn.textContent = "Click to reveal";
                                
                    const time = document.createElement("p");
                    time.className = "entry-modified-time";
                    time.textContent = formatDate(entry.timestamp) || "Unknown";
                                
                    const deleteBtn = document.createElement("button");
                    deleteBtn.className = "delete-btn";
                                
                    const deleteIcon = document.createElement("img");
                    deleteIcon.src = "./bin.png"; 
                    deleteIcon.alt = "Delete";
                                
                    deleteBtn.appendChild(deleteIcon);
                                
                    deleteBtn.addEventListener("click", async () => {
                        const confirmed = confirm("Delete this entry?");
                        if (!confirmed) return;

                        try {
                            const res = await fetch(`${BACKEND_URL}/clipboard/delete/${entry.id}`, {
                                method: "DELETE"
                            });
                            if (res.ok) {
                                row.remove();
                            } else {
                                const data = await res.json();
                                alert("Error deleting entry: " + (data.detail || res.statusText));
                            }
                        } catch (err) {
                            console.error("Error deleting entry:", err);
                            alert("Could not connect to backend.");
                        }
                    });
                
                    btn.addEventListener("click", () => {
                        if (btn.dataset.enabled === "false") {
                            btn.dataset.enabled = "true";
                            btn.textContent = entry.content || "[Empty]";
                        } else {
                            btn.dataset.enabled = "false";
                            btn.textContent = "Click to reveal";
                        }
                    });
                
                    row.appendChild(btn);
                    row.appendChild(time);
                    row.appendChild(deleteBtn);
                    container.appendChild(row);
                });

            } catch (err) {
                console.error("Error loading history:", err);
            }
        }

        async function clearHistory() {
            const healthy = await checkHealth();
            if (!healthy) {
                alert("Backend unavailable. Please ensure the server is running.");
                return;
            }

            try {
                await fetch(`${BACKEND_URL}/clipboard/clear-history`, {
                    method: "DELETE"
                });
                document.getElementById("entries-container").innerHTML = "";
            } catch (err) {
                console.error("Error clearing history:", err);
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            loadHistory();

            document.querySelector(".clear-history-btn").addEventListener("click", () => {
                clearHistory();
            });
        });
    </script>
</body>
</html>