<!DOCTYPE html>
<html lang="en">
    <head>
        <title>ClipVault</title>
        <link rel="stylesheet" href="style_main.css">
        <link rel="stylesheet" href="style_darkmode.css">
    </head>
    <body>
        <div class="header">
            <div class="header-content">
                <img src="./logo.png" alt="ClipVault Logo" class="logo">
                <div class="header-name">
                    <p>ClipVault</p>
                </div>
            </div>
        </div>

        <!-- Add connection status display -->
        <div id="connection-status" class="status-container"></div>
        
        <!-- User info display -->
        <div class="user-info">
            <p id="current-user">Loading user info...</p>
        </div>

        <div class="button-container">
            <button class="history-btn" onclick="window.location.href='history.html'">Clipboard History</button>
            <button class="preferences-btn" onclick="window.location.href='preferences.html'">User Preferences</button>
            <button class="logout-btn" onclick="logout()">Log out</button>
        </div>

        <script>
            window.onload = async () => {
                const currentUserEl = document.getElementById('current-user');
                const statusElement = document.getElementById('connection-status');

                let username = null;
                let isLoggedIn = false;

                if (window.backend?.auth) {
                    isLoggedIn = window.backend.auth.isLoggedIn();
                    username = window.backend.auth.getUsername();
                } else {
                    const token = localStorage.getItem('clipvault_token');
                    username = localStorage.getItem('clipvault_username');
                    isLoggedIn = !!token;
                }
            
                if (!isLoggedIn) {
                    window.location.href = 'login.html';
                    return;
                }
            
                currentUserEl.textContent = `Welcome, ${username || 'User'}!`;
            
                if (window.backend?.testConnection) {
                    try {
                        const result = await window.backend.testConnection();
                    
                        if (result.status === 'ok') {
                            statusElement.innerHTML = `
                                <div class="status-ok">
                                    <strong>ClipVault Secure</strong><br>
                                    Backend: Connected<br>
                                    Encryption: ${result.security?.encryption_working ? 'Active' : 'Error'}<br>
                                    Keys: ${result.security?.keys_available ? 'Available' : 'Missing'}
                                </div>
                            `;
                            statusElement.style.color = '#28a745';
                        } else {
                            statusElement.innerHTML = `<div class="status-error">Backend Error</div>`;
                            statusElement.style.color = '#dc3545';
                        }
                    } catch (error) {
                        console.error('Connection test failed:', error);
                        statusElement.innerHTML = `<div class="status-error">Could not connect to backend</div>`;
                        statusElement.style.color = '#dc3545';
                    }
                } else {
                    statusElement.innerHTML = `<div class="status-ok">Running in browser mode</div>`;
                    statusElement.style.color = '#6c757d';
                }
            };
        
            function logout() {
                if (confirm('Are you sure you want to log out?')) {
                    if (window.backend?.auth?.logout) {
                        window.backend.auth.logout();
                    } else {
                        localStorage.removeItem('clipvault_token');
                        localStorage.removeItem('clipvault_username');
                        window.location.href = 'login.html';
                    }
                }
            }
        
            function exitApp() {
                if (window.backend?.exitApp) {
                    window.backend.exitApp();
                } else {
                    window.close();
                }
            }
        </script>
        <script src="darkmode.js"></script>
        <script src="renderer.js"></script>
    </body>
</html>